<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fire Watch HUB</title>

    <!-- Tailwind (CDN) -->
     <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        boxShadow: {
          soft: "0 10px 30px rgba(0,0,0,0.10)",
        },
      },
    },
  };
</script>

  </head>

  <body class="bg-zinc-950 text-slate-100">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 border-b border-white/10 bg-zinc-950/70 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="grid h-10 w-10 place-items-center rounded-xl bg-orange-500/15 ring-1 ring-orange-400/25">
              <span class="text-xl"><img src="fire.png" alt="fire" class="h-6 w-6"></span>
            </div>
            <div>
              <h1 class="text-sm font-semibold tracking-wide sm:text-base">Fire Watch HUB</h1>
              <p class="text-xs text-slate-300">Live incident tracking </p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <span id="lastUpdated" class="hidden text-xs text-slate-300 sm:inline">Last updated: —</span>
            <button
              id="refreshBtn"
              class="inline-flex items-center gap-2 rounded-xl bg-white/10 px-3 py-2 text-sm font-medium ring-1 ring-white/10 hover:bg-white/15"
            >
              <span>Refresh</span>
              <span class="text-slate-300">↻</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      <!-- Controls -->
      <section class="grid gap-4 lg:grid-cols-12">
        <!-- Search -->
        <div class="lg:col-span-5">
          <label class="block text-xs font-medium text-slate-300">Search</label>
          <div class="mt-2 flex items-center rounded-2xl bg-white/5 px-3 ring-1 ring-white/10 focus-within:ring-orange-400/40">
            <span class="mr-2 text-slate-400">⌕</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Incident name, county, status…"
              class="w-full bg-transparent py-3 text-sm text-slate-100 placeholder:text-slate-500 outline-none"
            />
          </div>
        </div>

        <!-- Filters -->
        <div class="lg:col-span-7 grid gap-4 sm:grid-cols-3">
          <div>
            <label class="block text-xs font-medium text-slate-300">Status</label>
            <select
              id="statusFilter"
              class="mt-2 w-full rounded-2xl bg-zinc-900 px-3 py-3 text-sm ring-1 ring-white/10 outline-none focus:ring-orange-400/40"
            >
              <option value="all">All</option>
              <option value="active">Active</option>
              <option value="contained">Contained</option>
              <option value="out">Out</option>
              <option value="watch">Watch</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-slate-300">Severity</label>
            <select
              id="severityFilter"
              class="mt-2 w-full rounded-2xl bg-zinc-900 px-3 py-3 text-sm ring-1 ring-white/10 outline-none focus:ring-orange-400/40"
            >
              <option value="all">All</option>
              <option value="low">Low</option>
              <option value="moderate">Moderate</option>
              <option value="high">High</option>
              <option value="extreme">Extreme</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-slate-300">Sort</label>
            <select
              id="sortBy"
              class="mt-2 w-full rounded-2xl bg-zinc-900 px-3 py-3 text-sm ring-1 ring-white/10 outline-none focus:ring-orange-400/40"
            >
              <option value="updated_desc">Updated (new → old)</option>
              <option value="acres_desc">Acres (high → low)</option>
              <option value="containment_desc">Containment (high → low)</option>
              <option value="severity_desc">Severity (high → low)</option>
              <option value="name_asc">Name (A → Z)</option>
            </select>
          </div>
        </div>
      </section>

      <!-- KPI Cards -->
      <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-3xl bg-white/5 p-5 ring-1 ring-white/10 shadow-soft">
          <p class="text-xs text-slate-300">Active Incidents</p>
          <div class="mt-2 flex items-end justify-between">
            <p id="kpiActive" class="text-3xl font-semibold">—</p>
            <span class="rounded-full bg-orange-500/15 px-2 py-1 text-xs text-orange-200 ring-1 ring-orange-400/20">live</span>
          </div>
        </div>

        <div class="rounded-3xl bg-white/5 p-5 ring-1 ring-white/10 shadow-soft">
          <p class="text-xs text-slate-300">Total Acres</p>
          <div class="mt-2 flex items-end justify-between">
            <p id="kpiAcres" class="text-3xl font-semibold">—</p>
            <span class="text-xs text-slate-400">sum</span>
          </div>
        </div>

        <div class="rounded-3xl bg-white/5 p-5 ring-1 ring-white/10 shadow-soft">
          <p class="text-xs text-slate-300">Avg Containment</p>
          <div class="mt-2 flex items-end justify-between">
            <p id="kpiContainment" class="text-3xl font-semibold">—</p>
            <span class="text-xs text-slate-400">%</span>
          </div>
        </div>

        <div class="rounded-3xl bg-white/5 p-5 ring-1 ring-white/10 shadow-soft">
          <p class="text-xs text-slate-300">High / Extreme</p>
          <div class="mt-2 flex items-end justify-between">
            <p id="kpiHighExtreme" class="text-3xl font-semibold">—</p>
            <span class="rounded-full bg-red-500/15 px-2 py-1 text-xs text-red-200 ring-1 ring-red-400/20">risk</span>
          </div>
        </div>
      </section>

      <!-- Content Grid -->
      <section class="mt-6 grid gap-6 lg:grid-cols-12">
        <!-- Left: Table -->
        <div class="lg:col-span-8">
          <div class="rounded-3xl bg-white/5 ring-1 ring-white/10 shadow-soft">
            <div class="flex items-center justify-between px-5 py-4">
              <h2 class="text-sm font-semibold">Incidents</h2>
              <div class="text-xs text-slate-300">
                Showing <span id="rowCount">0</span>
              </div>
            </div>

            <div class="overflow-x-auto border-t border-white/10">
              <table class="min-w-full text-left text-sm">
                <thead class="bg-white/5 text-xs uppercase tracking-wide text-slate-300">
                  <tr>
                    <th class="px-5 py-3">Incident</th>
                    <th class="px-5 py-3">County</th>
                    <th class="px-5 py-3">Status</th>
                    <th class="px-5 py-3">Severity</th>
                    <th class="px-5 py-3">Acres</th>
                    <th class="px-5 py-3">Containment</th>
                    <th class="px-5 py-3">Updated</th>
                  </tr>
                </thead>
                <tbody id="incidentsTbody" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>

<!-- Map View (Leaflet) -->
<div class="mt-6 rounded-3xl bg-white/5 p-5 ring-1 ring-white/10 shadow-soft">
  <div class="flex items-center justify-between">
    <h2 class="text-sm font-semibold">Map View</h2>
    <span class="text-xs text-slate-400">Markers from incident coords</span>
  </div>

  <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-white/10">
    <div id="map" class="h-72 w-full"></div>
  </div>

  <p class="mt-3 text-xs text-slate-300">
    Tip: click a row to zoom to it.
  </p>
</div>


        </div>


        
        <!-- Right: Quick Panels -->
        <div class="lg:col-span-4 space-y-6">
          <!-- Alerts -->
          <div class="rounded-3xl bg-gradient-to-b from-red-500/15 to-red/5 p-5 ring-1 ring-white/10 shadow-soft">
            <div class="flex items-center justify-between">
              <h2 class="text-sm font-semibold">Alerts</h2>
              <span class="text-xs text-slate-400"></span>
            </div>
            <ul id="alertsList" class="mt-4 space-y-3"></ul>
          </div>



        </div>
      </section>

      <footer class="mt-10 border-t border-white/10 pt-6 text-xs text-slate-400">
        <p class="text-center font-medium text-white">Fire Watch Dashboard</p>
        <p class="text-center"> Map powered by OpenStreetMap</p>
        <p class="mt-2 text-center text-slate-500"><a href="https://taurreantraylor.com" target="_blank" rel="noreferrer">Taurrean Traylor</a></p>
      </footer>
    </main>

    <script>


let Incidents = [];

// ---------------------------
// Constants
// ---------------------------
const severityRank = { low: 1, moderate: 2, high: 3, extreme: 4 };
const statusLabel = { active: "Active", contained: "Contained", out: "Out", watch: "Watch" };

const FIRE_API_URL = "https://services3.arcgis.com/T4QMspu9Pqn9QH9E/arcgis/rest/services/Current_WildlandFire_Locations/FeatureServer/0/query?where=OBJECTID>0&outFields=*&outSR=4326&f=pjson";
// ---------------------------
// Elements
// ---------------------------
const tbody = document.getElementById("incidentsTbody");
const rowCountEl = document.getElementById("rowCount");
const lastUpdatedEl = document.getElementById("lastUpdated");

const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const severityFilter = document.getElementById("severityFilter");
const sortBy = document.getElementById("sortBy");
const refreshBtn = document.getElementById("refreshBtn");

const kpiActive = document.getElementById("kpiActive");
const kpiAcres = document.getElementById("kpiAcres");
const kpiContainment = document.getElementById("kpiContainment");
const kpiHighExtreme = document.getElementById("kpiHighExtreme");

const alertsList = document.getElementById("alertsList");

// ---------------------------
// Helpers
// ---------------------------
const fmtNum = (n) => new Intl.NumberFormat().format(n);

const fmtDateTime = (iso) => {
  const d = new Date(iso);
  return d.toLocaleString([], { month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
};

function pill(cls, text) {
  return `<span class="inline-flex items-center rounded-full px-2 py-1 text-xs ring-1 ${cls}">${text}</span>`;
}

function statusPill(status) {
  switch (status) {
    case "active":
      return pill("bg-orange-500/15 text-orange-200 ring-orange-400/25", "Active");
    case "contained":
      return pill("bg-emerald-500/15 text-emerald-200 ring-emerald-400/25", "Contained");
    case "out":
      return pill("bg-slate-500/15 text-slate-200 ring-slate-400/25", "Out");
    case "watch":
      return pill("bg-indigo-500/15 text-indigo-200 ring-indigo-400/25", "Watch");
    default:
      return pill("bg-white/10 text-slate-200 ring-white/10", status);
  }
}

function severityPill(sev) {
  switch (sev) {
    case "low":
      return pill("bg-sky-500/15 text-sky-200 ring-sky-400/25", "Low");
    case "moderate":
      return pill("bg-yellow-500/15 text-yellow-200 ring-yellow-400/25", "Moderate");
    case "high":
      return pill("bg-red-500/15 text-red-200 ring-red-400/25", "High");
    case "extreme":
      return pill("bg-fuchsia-500/15 text-fuchsia-200 ring-fuchsia-400/25", "Extreme");
    default:
      return pill("bg-white/10 text-slate-200 ring-white/10", sev);
  }
}


//
async function fetchFireData() {
  try {
    const API_URL = "https://services3.arcgis.com/T4QMspu9Pqn9QH9E/arcgis/rest/services/WFIGS_Incident_Locations_YearToDate/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json";
    const response = await fetch("https://corsproxy.io/?" + encodeURIComponent(API_URL));
    const data = await response.json();

    // If real data exists, use it!
    if (data.features && data.features.length > 0) {
      Incidents = data.features.map((f) => {
        const a = f.attributes;
        return {
          id: a.OBJECTID || Math.random(),
          name: a.IncidentName || "Unknown Incident",
          county: a.POOCounty || "Unassigned",
          status: a.IncidentStatusKind ? a.IncidentStatusKind.toLowerCase() : "active",
          severity: (a.IncidentSize > 5000) ? "high" : "moderate",
          acres: Math.round(a.IncidentSize || 0),
          containment: a.PercentContained || 0,
          updatedAt: a.ModifiedOnDateTime_dt || new Date().toISOString(),
          lat: a.InitialLatitude || (f.geometry ? f.geometry.y : 0),
          lng: a.InitialLongitude || (f.geometry ? f.geometry.x : 0),
        };
      });
    } 
// Fallback sample data if feed is unavailable
    else {
      Incidents = [
        {
          id: 101,
          name: "Valley Creek (Sample)",
          county: "Ventura",
          status: "active",
          severity: "moderate",
          acres: 5810,
          containment: 33,
          updatedAt: new Date().toISOString(),
          lat: 34.37, lng: -119.13
        },
        {
          id: 102,
          name: "Pioneer Fire (Sample)",
          county: "Santa Clarita",
          status: "active",
          severity: "extreme",
          acres: 41110,
          containment: 0,
          updatedAt: new Date().toISOString(),
          lat: 34.3917, lng: -118.5426
        },
        {
          id: 103,
          name: "Canyon Ridge (Sample)",
          county: "Riverside",
          status: "active",
          severity: "high",
          acres: 12450,
          containment: 18,
          updatedAt: new Date().toISOString(),
          lat: 33.95, lng: -117.39
        }
      ];
    }
    render();
  } 
  catch (err) {
  console.error("Connection Error:", err);

  // fallback to sample data if fetch fails
  Incidents = [
    {
      id: 101,
      name: "Valley Creek",
      county: "Ventura",
      status: "active",
      severity: "moderate",
      acres: 5810,
      containment: 33,
      updatedAt: new Date().toISOString(),
      lat: 34.37, lng: -119.13
    },
    {
      id: 102,
      name: "Pioneer Fire",
      county: "Santa Clarita",
      status: "active",
      severity: "extreme",
      acres: 41110,
      containment: 0,
      updatedAt: new Date().toISOString(),
      lat: 34.3917, lng: -118.5426
    },
    {
      id: 103,
      name: "Canyon Ridge",
      county: "Riverside",
      status: "active",
      severity: "high",
      acres: 12450,
      containment: 18,
      updatedAt: new Date().toISOString(),
      lat: 33.95, lng: -117.39
    }
  ];

  render();
}

  }


//


// ---------------------------
// Filtering + Sorting
// ---------------------------
function getVisibleIncidents() {
  const q = (searchInput?.value || "").trim().toLowerCase();
  const st = statusFilter?.value || "all";
  const sev = severityFilter?.value || "all";

  let rows = [...Incidents];

  if (q) {
    rows = rows.filter((i) => {
      return (
        i.name.toLowerCase().includes(q) ||
        i.county.toLowerCase().includes(q) ||
        i.status.toLowerCase().includes(q) ||
        i.severity.toLowerCase().includes(q)
      );
    });
  }

  if (st !== "all") rows = rows.filter((i) => i.status === st);
  if (sev !== "all") rows = rows.filter((i) => i.severity === sev);

  const sortVal = sortBy?.value || "updated_desc";
  switch (sortVal) {
    case "updated_desc":
      rows.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      break;
    case "acres_desc":
      rows.sort((a, b) => b.acres - a.acres);
      break;
    case "containment_desc":
      rows.sort((a, b) => b.containment - a.containment);
      break;
    case "severity_desc":
      rows.sort((a, b) => severityRank[b.severity] - severityRank[a.severity]);
      break;
    case "name_asc":
      rows.sort((a, b) => a.name.localeCompare(b.name));
      break;
  }

  return rows;
}

// ---------------------------
// Table Render
// IMPORTANT: adds data-id so clicking works.
// ---------------------------
function renderTable(rows) {
  if (!tbody) return;

  tbody.innerHTML = rows
    .map((i) => {
      const containmentBar = `
        <div class="w-28">
          <div class="h-2 w-full rounded-full bg-white/10 ring-1 ring-white/10 overflow-hidden">
            <div class="h-full bg-emerald-400/70" style="width:${Math.max(0, Math.min(100, i.containment))}%"></div>
          </div>
          <div class="mt-1 text-xs text-slate-300">${i.containment}%</div>
        </div>
      `;

      return `
        <tr data-id="${i.id}" class="cursor-pointer hover:bg-white/5">
          <td class="px-5 py-4">
            <div class="font-medium">${i.name}</div>
            <div class="mt-1 text-xs text-slate-400">${i.id}</div>
          </td>
          <td class="px-5 py-4 text-slate-200">${i.county}</td>
          <td class="px-5 py-4">${statusPill(i.status)}</td>
          <td class="px-5 py-4">${severityPill(i.severity)}</td>
          <td class="px-5 py-4 tabular-nums">${fmtNum(i.acres)}</td>
          <td class="px-5 py-4">${containmentBar}</td>
          <td class="px-5 py-4 text-slate-300">${fmtDateTime(i.updatedAt)}</td>
        </tr>
      `;
    })
    .join("");

  if (rowCountEl) rowCountEl.textContent = `${rows.length} incident${rows.length === 1 ? "" : "s"}`;
}

// ---------------------------
// KPI Render
// ---------------------------
function renderKPIs(rowsAll) {
  const activeCount = rowsAll.filter((i) => i.status === "active").length;
  const totalAcres = rowsAll.reduce((sum, i) => sum + (Number(i.acres) || 0), 0);
  const avgContain = rowsAll.length
    ? Math.round(rowsAll.reduce((s, i) => s + (Number(i.containment) || 0), 0) / rowsAll.length)
    : 0;
  const highExtreme = rowsAll.filter((i) => i.severity === "high" || i.severity === "extreme").length;

  if (kpiActive) kpiActive.textContent = fmtNum(activeCount);
  if (kpiAcres) kpiAcres.textContent = fmtNum(totalAcres);
  if (kpiContainment) kpiContainment.textContent = `${avgContain}%`;
  if (kpiHighExtreme) kpiHighExtreme.textContent = fmtNum(highExtreme);

  const latest = rowsAll.map((i) => new Date(i.updatedAt)).sort((a, b) => b - a)[0];
  if (lastUpdatedEl) lastUpdatedEl.textContent = latest ? `Last updated: ${latest.toLocaleString()}` : "Last updated: —";
}

// ---------------------------
// Alerts Render
// ---------------------------
function renderAlerts(rowsAll) {
  if (!alertsList) return;

  const alerts = [];
  rowsAll.forEach((i) => {
    if (i.severity === "extreme" && i.status === "active") {
      alerts.push({
        title: "Extreme active incident",
        body: `${i.name} in ${i.county} County is marked EXTREME and ACTIVE.`,
        badge: "Critical",
        badgeClass: "bg-red-500/15 text-red-200 ring-red-400/25",
      });
    }
    if (i.acres >= 10000 && i.status === "active") {
      alerts.push({
        title: "Large fire footprint",
        body: `${i.name} has exceeded ${fmtNum(i.acres)} acres.`,
        badge: "High",
        badgeClass: "bg-orange-500/15 text-orange-200 ring-orange-400/25",
      });
    }
    if (i.containment === 0 && (i.status === "active" || i.status === "watch")) {
      alerts.push({
        title: "No containment reported",
        body: `${i.name} currently shows 0% containment.`,
        badge: "Watch",
        badgeClass: "bg-indigo-500/15 text-indigo-200 ring-indigo-400/25",
      });
    }
  });

  const list = alerts.slice(0, 6);
  alertsList.innerHTML = list.length
    ? list
        .map(
          (a) => `
            <li class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold">${a.title}</p>
                  <p class="mt-1 text-sm text-slate-200/90">${a.body}</p>
                </div>
                <span class="inline-flex shrink-0 items-center rounded-full px-2 py-1 text-xs ring-1 ${a.badgeClass}">${a.badge}</span>
              </div>
            </li>
          `
        )
        .join("")
: `<li class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 text-sm text-slate-300">No active alerts.</li>`;
}

// ---------------------------
// Leaflet Map
// ---------------------------
let map;
let markersLayer;

function initMapOnce() {
  if (map) return;

  // If map div doesn't exist, just skip safely
  const mapEl = document.getElementById("map");
  if (!mapEl) return;

  // Leaflet must be loaded (L exists)
  if (typeof L === "undefined") {
    console.error("Leaflet (L) not found. Make sure leaflet.js is loaded before this script.");
    return;
  }

  map = L.map("map", { zoomControl: true }).setView([34.05, -118.25], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
}


// Custom Fire Icon
const fireIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/785/785116.png', // You can also use your local fire.png
    iconSize: [32, 32], // Size of the icon
    iconAnchor: [16, 32], // Point of the icon which will correspond to marker's location
    popupAnchor: [0, -32] // Point from which the popup should open relative to the iconAnchor
});


function renderMapMarkers(incidents) {
  initMapOnce();
  if (!map || !markersLayer) return;

  markersLayer.clearLayers();
  
  // Track points to make sure the map shows all fires
  const points = [];

  incidents
    .filter((i) => typeof i.lat === "number" && typeof i.lng === "number")
    .forEach((i) => {
      // FIX 1: Add { icon: fireIcon } here
      const m = L.marker([i.lat, i.lng], { icon: fireIcon }).addTo(markersLayer);
      
      m.bindPopup(
        `<strong>${i.name}</strong><br/>${i.county} County<br/>${statusLabel[i.status] || i.status} • ${
          i.severity
        }<br/>Acres: ${fmtNum(i.acres)}`
      );
      m.__incidentId = i.id;
      
      // Collect the location
      points.push([i.lat, i.lng]);
    });

  // FIX 2: Auto-zoom so Canyon Ridge isn't hidden off-screen
  if (points.length > 0) {
    const bounds = L.latLngBounds(points);
    map.fitBounds(bounds, { padding: [40, 40] });
  }
}


function zoomToIncident(id) {
  if (!map || !markersLayer) return;

  let targetMarker = null;

  // Look through the map markers for the one that matches the clicked ID
  markersLayer.eachLayer((layer) => {
    // We convert both to strings to ensure they match correctly
    if (String(layer.__incidentId) === String(id)) {
      targetMarker = layer;
    }
  });

  if (targetMarker) {
    // 1. Zoom and center the map on the fire
    map.setView(targetMarker.getLatLng(), 12, { animate: true });
    
    // 2. Automatically open the popup so the user sees the details
    targetMarker.openPopup();
    
    // 3. Scroll the map into view (useful for mobile users)
    document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else {
    console.warn("No marker found for ID:", id);
  }
}
// ---------------------------
// Row Click Wiring
// NOTE: Because table re-renders, we re-wire after renderTable()
// ---------------------------
function wireRowClicks() {
  const rows = document.querySelectorAll("#incidentsTbody tr[data-id]");
  rows.forEach((tr) => {
    tr.onclick = function() {
      const id = this.getAttribute("data-id");
      zoomToIncident(id);
    };
  });
}

// ---------------------------
// Main Render (ONLY ONE render() now)
// ---------------------------
function render() {
  const visible = getVisibleIncidents();
  renderTable(visible);
  renderKPIs(Incidents);
  renderAlerts(Incidents);

  renderMapMarkers(Incidents);
  wireRowClicks();
}

// ---------------------------
// Events
// ---------------------------
[searchInput, statusFilter, severityFilter, sortBy].forEach((el) => {
  if (el) el.addEventListener("input", render);
});

if (refreshBtn) {
  refreshBtn.addEventListener("click", () => {
fetchFireData();
  });
}

// ---------------------------
// Initial
// If your script is in <head>, wrap in DOMContentLoaded.
// If your script is at end of <body>, this is fine.
// ---------------------------
fetchFireData();
</script>
    

  </body>
</html>
